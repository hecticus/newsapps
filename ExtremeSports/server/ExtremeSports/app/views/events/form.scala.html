@(eventsForm: Form[models.events.Event])

@import helper._
@import helper.twitterBootstrap._
@import helpers._

@title = {}

@categoryGroup(field: Field, className: String = "category") = {
    <div class="twipsies well @className">
        <a class="removeCategory btn btn-primary danger pull-right">@Messages("event.category.remove")</a>
        @select(
            field("category.idCategory"),
            models.content.posts.Category.toSeq,
            '_label -> Messages("event.category"),
            'class -> "form-control"
        )
    </div>
}

@localizationGroup(field: Field, className: String = "localization") = {
    <div class="twipsies well @className">
        <a class="removeLocalization btn btn-primary danger pull-right">@Messages("post.localization.remove")</a>
        @select(
            field("language.idLanguage"),
            models.basic.Language.toSeq,
            '_label -> Messages("post.localization.language"),
            'class -> "form-control"
        )
        @input(field("name"), '_label -> Messages("post.localization.title")) { (id, name, value, _) =>
            <input type="text" name="@name" value="@value" class="form-control" >
        }
        @input(field("description"), '_label -> Messages("post.localization.content")) { (id, name, value, _) =>
            <input type="text" name="@name" value="@value" class="form-control" >
        }
    </div>
}

@main(title = Messages("events.create"), nav = "create") {
    
     @if(flash.containsKey("success")) {
        <div class="alert-message warning">
            <strong>@Messages("generic.error.title")</strong> @flash.get("success")
        </div>
    }

    @if(eventsForm.hasErrors) {
        <div class="alert alert-dismissable alert-danger">
            <button type="button" class="close" data-dismiss="alert">Ã—</button>
            <strong>@Messages("generic.error.title")</strong> @Messages("generic.error.content")
            <p>@eventsForm.errorsAsJson</p>
        </div>
    }


    @helper.form(action = controllers.routes.EventsView.submit, 'enctype -> "multipart/form-data", 'id -> "form") {
        
        <fieldset>
            <legend>@Messages("events.info")</legend>

            <div class="row">
                <div class="col-lg-6">
                    @datetimepicker("date", eventsForm("date"), Messages("post.date"))
                </div>
                <div class="col-lg-6">
                    @select(
                        eventsForm("country.idCountry"),
                        models.basic.Country.toSeq,
                        '_label -> Messages("post.country"),
                        'class -> "form-control"
                    )
                </div>
            </div>

            <div class="form-group">
                <label for="inputFile" class="col-lg-2 control-label">@Messages("events.image")</label>
                <div class="col-lg-10">
                    @input(eventsForm("image"), '_label -> Messages("events.image.file")) { (id, name, value, _) =>
                        <input type="text" name="@name" value="@value" readonly="" class="form-control floating-label" placeholder="Browse...">
                        <input type="file" name="@name" value="@value" id="inputFile" multiple="">
                    }
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <h2>@Messages("post.localization")</h2>
                </div>
            </div>
            <div id="localizations">

                @repeat(eventsForm("localizations")) { localization =>
                    @localizationGroup(localization)
                }
                @localizationGroup(
                    eventsForm("localizations[x]"),
                    className = "localization_template"
                )

                <div class="manage">
                    <a class="addLocalization btn btn-primary success">@Messages("post.localization.add")</a>
                </div>

            </div>

            <div class="row">
                <div class="col-lg-12">
                    <h2>@Messages("post.category.plural")</h2>
                </div>
            </div>
            <div id="categories">

                @repeat(eventsForm("categories")) { category =>
                    @categoryGroup(category)
                }


                <div class="manage">
                    <a class="addCategory btn btn-primary success">@Messages("post.category.add")</a>
                </div>

            </div>

            <div class="row">
                <div class="col-lg-12">
                    <h2>@Messages("event.location")</h2>
                </div>
            </div>
            <div id="location">
                <div class="row">
                    <div class="col-lg-6">
                        @inputText(
                            eventsForm("latitude"),
                            '_label -> Messages("events.latitude"),
                            '_help -> Messages("events.latitude.help"),
                            'class -> "form-control",
                            '_error -> eventsForm.globalError
                        )
                    </div>
                    <div class="col-lg-6">
                        @inputText(
                            eventsForm("longitude"),
                            '_label -> Messages("events.longitude"),
                            '_help -> Messages("events.longitude.help"),
                            'class -> "form-control",
                            '_error -> eventsForm.globalError
                        )
                    </div>
                </div>
                <div id="map-canvas"></div>
            </div>


            
        </fieldset>

        <div class="actions">
            <input type="submit" class="btn btn-success" value=@Messages("post.submit.create")>
            <a href="@controllers.routes.EventsView.list()" class="btn btn-primary">@Messages("generic.cancel")</a>
        </div>
        
    }

    <script type="text/javascript" charset="utf-8">

        $('#form').submit(function() {
            $('.category_template').remove()
            $('.localization_template').remove()
        })

        $(document).on('click','.removeCategory', function(e) {
            $(this).parents('.category').remove()
            renumberCategories()
        })

        $(document).on('click','.addCategory', function(e) {
            var template = $('.category_template')
            template.before('<div class="twipsies well category">' + template.html() + '</div>')
            renumberCategories()
        })

        var renumberCategories = function() {
            $('.category').each(function(i) {
                $('select', this).each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/categories\[.+?\]/g, 'categories[' + i + ']'))
                    $(this).attr('id', $(this).attr('id').replace(/categories\_x/g, 'categories_' + i))

                })
            })
        }

        $(document).on('click','.removeLocalization', function(e) {
            $(this).parents('.localization').remove()
            renumberLocalizations()
        })

        $(document).on('click','.addLocalization', function(e) {
            var template = $('.localization_template')
            template.before('<div class="twipsies well localization">' + template.html() + '</div>')
            renumberLocalizations()
        })

        var renumberLocalizations = function() {
            $('.localization').each(function(i) {
                $('select', this).each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/localizations\[.+?\]/g, 'localizations[' + i + ']'))
                })
                $('input', this).each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/localizations\[.+?\]/g, 'localizations[' + i + ']'))
                })
            })
        }

        var marker;

        function placeMarker(location, map) {
            if ( marker ) {
                marker.setPosition(location);
            } else {
                marker = new google.maps.Marker({
                    position: location,
                    map: map
                });
            }
        }

        function initialize() {
            var mapCanvas = document.getElementById('map-canvas');
            var mapOptions = {
                center: new google.maps.LatLng(10.45063, -66.8793),
                zoom: 8,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            var map = new google.maps.Map(mapCanvas, mapOptions)

            google.maps.event.addListener(map, "rightclick", function(event) {
                var lat = event.latLng.lat();
                var lng = event.latLng.lng();
                //alert("Lat=" + lat + "; Lng=" + lng);

                var locLat = document.getElementById('latitude');
                var locLong = document.getElementById('longitude');

                locLat.value = lat;

                locLong.value = lng;


                placeMarker(event.latLng, map);
            });
        }
        google.maps.event.addDomListener(window, 'load', initialize);



    </script>
 
}